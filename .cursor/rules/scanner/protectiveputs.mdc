---
alwaysApply: false
---
# Protective Put Strategy Evaluation Service Guidelines for Cursor

You are implementing a **Protective Put Analyzer** service — part of the option strategy evaluation suite (alongside Covered Call Analyzer, OptionScanner, etc.) in the myInvestments app.

The service identifies protective put positions (long stock + long put as downside hedge), evaluates their current effectiveness, cost, and risk profile, and provides recommendations:
- HOLD the protective put
- SELL_TO_CLOSE (STC) the put (if protection no longer needed or too expensive)
- ROLL the put (STC current → buy new at different strike/expiration)
- BUY additional protection (if risk has increased significantly)

This runs via the scheduler (new/extended job type: `protectivePutScanner`) and generates alerts/recommendations.

## Core Goals
- Detect protective put structures (long ≥100 shares + long put on same underlying/account)
- Assess whether the hedge is still appropriate given:
  - Current stock price vs put strike
  - Remaining time value / extrinsic value
  - Cost of protection (premium paid vs current put value)
  - Account risk profile & overall portfolio volatility
- Provide conservative, capital-preservation-focused recommendations

## Key Evaluation Rules (default — make configurable per account later)

| Condition                                      | Recommendation       | Reason / Thresholds                                                                 |
|------------------------------------------------|----------------------|--------------------------------------------------------------------------------------|
| Stock price > put strike + 10–15% buffer       | STC                  | Stock moved up significantly — protection no longer cost-effective                  |
| Put extrinsic value < 10% of original premium  | STC or roll out      | Most time value decayed — hedge is expensive relative to remaining protection       |
| DTE ≤ 10 & put still OTM                       | STC                  | Little protection left; avoid paying for near-worthless insurance                   |
| Stock dropped > 8–12% from entry & put ITM     | HOLD or roll down/out| Hedge is working — keep protection or extend duration/strike                        |
| Implied volatility spiked > 40% since purchase | HOLD                 | Higher IV increases put value — good time to keep hedge                             |
| Account risk = aggressive & stock > breakeven  | STC                  | Remove hedge to free capital for other opportunities                                |
| No protective put & stock volatility > 35%     | BUY protective put   | Opportunity: add downside protection on volatile holdings                           |
| Put delta ≤ -0.25 & stock stable               | STC                  | Protection too far OTM — ineffective relative to cost                               |

## Metrics to Compute & Include
- Current stock price
- Put current bid/ask/mid
- Net cost of protection (premium paid – current put value)
- Effective floor (put strike – net cost per share)
- Days to expiration (DTE)
- Delta of put
- Implied volatility / IV rank
- Unrealized P/L on stock leg
- Cost of protection as % of stock value (annualized if possible)

## Implementation Structure

1. **Core Service**
   `src/lib/protective-put-analyzer.ts`
   ```ts
   async function analyzeProtectivePuts(userId?: string): Promise<ProtectivePutRecommendation[]>

   interface ProtectivePutRecommendation {
     accountId: string
     symbol: string
     stockPositionId?: string
     putPositionId?: string
     recommendation: 'HOLD' | 'SELL_TO_CLOSE' | 'ROLL' | 'BUY_NEW_PUT' | 'NONE'
     confidence: 'HIGH' | 'MEDIUM' | 'LOW'
     reason: string
     suggestedStrike?: number
     suggestedExpiration?: Date
     metrics: {
       stockPrice: number
       putBid: number
       putAsk: number
       dte: number
       netProtectionCost: number        // positive = cost, negative = profit
       effectiveFloor: number
       putDelta: number
       iv: number
       stockUnrealizedPl: number
       protectionCostPercent: number
     }
   }
   ```

2. **Data Dependencies**
   - Extend `src/lib/yahoo-finance.ts`:
     - Reuse `getOptionChainDetailed(underlying, expiration?)` for put chain
     - `getHistoricalVolatility(symbol: string, period: '30d'|'60d'|'1y')` if needed for context
     - `getCurrentIV(symbol: string)` or rely on option chain IV

3. **Scheduler Integration**
   - Job type: `protectivePutScanner`
   - Suggested schedule: same as `coveredCallScanner` (daily Mon–Fri ~4 PM)
   - Handler: `analyzeProtectivePuts()` → persist to `recommendations`/`alerts` → trigger notifications

4. **Storage & Visibility**
   - Store in MongoDB (same collection as other recommendations/alerts)
   - Alert example:
     "Protective Put [symbol]: [RECOMMENDATION] — [reason]. Stock $[price], Put $[bid]–$[ask], DTE [dte], Floor $[effectiveFloor]"

## File Targets
- `src/lib/protective-put-analyzer.ts`     ← main logic + rule engine
- `src/lib/yahoo-finance.ts`               ← ensure put chain & IV helpers are solid
- `src/lib/scheduler.ts`                   ← register protectivePutScanner job
- `src/types/portfolio.ts`                 ← add ProtectivePutRecommendation type
- `src/app/api/scheduler/route.ts`         ← support new job type if needed

## Acceptance Criteria
- Accurately pairs long stock + long put positions
- Recommendations follow rules table on test scenarios
- Uses real-time Yahoo option prices & greeks
- Handles missing data / expired puts gracefully
- Job runs cleanly via scheduler
- Core functions are pure/unit-test friendly where possible

## Suggested Order
1. Ensure `yahoo-finance.ts` can reliably fetch put chains + greeks
2. Implement `protective-put-analyzer.ts` with position detection + rules
3. Add job registration in scheduler
4. Define types & basic persistence/alert logic

Prioritize correct identification of protective put structures and sensible, risk-aware recommendations over visual polish.
