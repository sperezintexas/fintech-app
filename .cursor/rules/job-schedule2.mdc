---
alwaysApply: false
---
# Job/Report Configuration Feature

## Overview
Unified job configuration: jobs stored in `reportJobs` collection, scheduled via Agenda `scheduled-report`, executed by `executeJob`. Use report types from `reportTypes` collection; deprecated types (OptionScanner, coveredCallScanner, etc.) are disabled—prefer `unifiedOptionsScanner` and `watchlistreport`.

## Core Options (All Jobs)
- **name**: String - Unique job name.
- **jobType**: String - Type id from reportTypes (e.g. `unifiedOptionsScanner`, `watchlistreport`, `portfoliosummary`).
- **scheduleCron**: String - Cron schedule (e.g. `0 16 * * 1-5` for Mon–Fri 4 PM).
- **channels**: Array - Delivery channels: `slack`, `twitter` (X).
- **config**: Record<string, unknown> - Type-specific JSON (validated by Zod per handlerKey).
- **accountId**: string | null - null = portfolio-level; string = single account.

## Recommended Job Types (enabled)
- **unifiedOptionsScanner** - Runs Option, Covered Call, Protective Put, Straddle/Strangle scanners in one job.
- **watchlistreport** - Market snapshot + rationale; runs daily analysis and creates alerts.
- **portfoliosummary** - Multi-account overview; optional `includeAiInsights`.
- **deliverAlerts** - Sends pending alerts to Slack/X.
- **cleanup** - Purges old reports/alerts when storage nears limit.

## Deprecated (enabled: false)
- daily-analysis, OptionScanner, coveredCallScanner, protectivePutScanner.
- Use unifiedOptionsScanner or watchlistreport instead.

## Data Model
- **reportJobs** - Jobs with name, jobType, scheduleCron, channels, config, accountId.
- **reportTypes** - Job type definitions (handlerKey, enabled, defaultConfig).
- **scheduled-report** - Agenda job; data.jobId → executeJob(jobId).

## Implementation
- API: `/api/jobs` (GET/POST), `/api/jobs/[id]` (PUT/DELETE/POST for Run Now).
- Scheduler: `upsertReportJobSchedule(jobId, cron)`, `cancelReportJobSchedule(jobId)`.
- Create recommended jobs: POST /api/scheduler `{ action: "createRecommendedJobs" }`.
- Run portfolio: POST /api/scheduler `{ action: "runPortfolio" }` (unifiedOptionsScanner + watchlistreport + deliverAlerts).
