# Optional: calls your app's /api/cron/unified-options-scanner endpoint.
# NOT NEEDED on App Runner or EC2: Agenda runs inside the app and fires scheduled jobs from MongoDB.
# Use this workflow only if you are on serverless (no long-running process) or want a manual/backup trigger.
#
# To enable scheduled runs: uncomment the schedule block below and set vars.APP_URL + secrets.CRON_SECRET.
name: Cron – Unified Options Scanner (optional)

on:
  # Schedule disabled by default when using App Runner/EC2 (Agenda runs in-process).
  # schedule:
  #   - cron: "15 14 * * 1-5"
  #   - cron: "15 15 * * 1-5"
  #   - cron: "15 16 * * 1-5"
  #   - cron: "15 17 * * 1-5"
  #   - cron: "15 18 * * 1-5"
  #   - cron: "15 19 * * 1-5"
  #   - cron: "15 20 * * 1-5"
  workflow_dispatch:

jobs:
  trigger-scanner:
    name: Trigger unified options scanner
    runs-on: ubuntu-latest
    steps:
      - name: Call unified-options-scanner cron
        env:
          APP_URL: ${{ vars.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          if [ -z "$APP_URL" ] || [ -z "$CRON_SECRET" ]; then
            echo "::warning::Skipping cron: set vars.APP_URL and secrets.CRON_SECRET in repo Settings → Secrets and variables → Actions to run the scanner."
            echo "  Variables tab: APP_URL = your production URL (e.g. https://xxx.awsapprunner.com)"
            echo "  Secrets tab: CRON_SECRET = same as CRON_SECRET in your app env"
            exit 0
          fi
          BASE="${APP_URL%/}"
          URL="${BASE}/api/cron/unified-options-scanner"
          echo "Calling $URL ..."
          HTTP=$(curl -sSf -w "%{http_code}" -o /tmp/out -H "Authorization: Bearer $CRON_SECRET" "$URL")
          echo "HTTP $HTTP"
          cat /tmp/out
          if [ "$HTTP" -lt 200 ] || [ "$HTTP" -ge 300 ]; then
            echo "::error::Cron returned HTTP $HTTP"
            exit 1
          fi
