name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "20"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run ESLint
        run: npm run lint

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run TypeScript compiler
        run: npx tsc --noEmit

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run tests
        run: npm test

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build application
        run: npm run build
        env:
          MONGODB_URI: mongodb://localhost:27017
          MONGODB_DB: myinvestments

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: .next
          retention-days: 7

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: myinvestments:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            MONGODB_URI=mongodb://localhost:27017
            MONGODB_DB=myinvestments

  # Post build result to Slack. Requires SLACK_WEBHOOK_URL as a repo Secret.
  # To configure:
  #   1. Go to GitHub repo Settings → Secrets and variables → Actions
  #   2. Click "New repository secret"
  #   3. Name: SLACK_WEBHOOK_URL (case-sensitive, must be exact)
  #   4. Value: Your Slack Incoming Webhook URL (starts with https://hooks.slack.com/...)
  # The Slack channel is set when you create the Incoming Webhook (#smart-trader-build).
  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, build, docker]
    if: always() && !cancelled()
    steps:
      - name: Send Slack build notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          STATUS: ${{ (needs.lint.result == 'failure' || needs.typecheck.result == 'failure' || needs.test.result == 'failure' || needs.build.result == 'failure' || needs.docker.result == 'failure') && 'failure' || (needs.lint.result == 'cancelled' || needs.typecheck.result == 'cancelled' || needs.test.result == 'cancelled' || needs.build.result == 'cancelled' || needs.docker.result == 'cancelled') && 'cancelled' || 'success' }}
          RUN_URL: ${{ format('https://github.com/{0}/actions/runs/{1}', github.repository, github.run_id) }}
          BRANCH: ${{ github.ref_name }}
          COMMIT: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "::warning::SLACK_WEBHOOK_URL secret not found. To enable Slack notifications:"
            echo "  1. Go to GitHub repo Settings → Secrets and variables → Actions → Secrets"
            echo "  2. Create a repository secret named exactly: SLACK_WEBHOOK_URL"
            echo "  3. Paste your Slack Incoming Webhook URL as the value"
            echo "Skipping Slack notification."
            exit 0
          fi
          if [ "$STATUS" = "success" ]; then
            EMOJI=":white_check_mark:"
            COLOR="good"
            TEXT="CI passed"
          elif [ "$STATUS" = "cancelled" ]; then
            EMOJI=":warning:"
            COLOR="warning"
            TEXT="CI cancelled"
          else
            EMOJI=":x:"
            COLOR="danger"
            TEXT="CI failed"
          fi
          PAYLOAD=$(cat <<EOF
          {
            "attachments": [{
              "color": "$COLOR",
              "fallback": "$EMOJI $TEXT — $BRANCH",
              "title": "$EMOJI Build $TEXT",
              "title_link": "$RUN_URL",
              "fields": [
                { "title": "Branch", "value": "$BRANCH", "short": true },
                { "title": "Author", "value": "$ACTOR", "short": true },
                { "title": "Commit", "value": "<$RUN_URL|${COMMIT:0:7}>", "short": false }
              ]
            }]
          }
          EOF
          )
          curl -sSf -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$SLACK_WEBHOOK_URL" || true
